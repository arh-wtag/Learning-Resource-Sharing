name: CodeQL
on:
    push:
      branches:
        - main
        - codeql
# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]
# #   schedule:
#     - cron: '0 2 * * 1'  # Weekly schedule at 2 AM every Monday

jobs:
  analyze:
    name: Analyze CodeQL
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      matrix:
        language: ['python' ]  # Specify the languages your project uses

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: '/language:${{ matrix.language }}'
        output: ${{ github.workspace }}/results/${{ matrix.language }}.sarif

    - name: Upload CodeQL SARIF
      uses: actions/upload-artifact@v2
      with:
        name: codeql-sarif-${{ matrix.language }}
        path: ${{ github.workspace }}/results/${{ matrix.language }}.sarif

    - name: Setup CodeQL CLI
      run: |
        curl -L -o codeql.zip https://github.com/github/codeql-cli-binaries/releases/latest/download/codeql.zip
        unzip codeql.zip
        sudo mv codeql /opt/
        sudo ln -s /opt/codeql/codeql /usr/local/bin/codeql

    - name: Uploading results
      run: |
        echo "Uploading results"
        echo "Processing sarif files: [\"${GITHUB_WORKSPACE}/results/${{ matrix.language }}.sarif\"]"
        echo "Validating ${GITHUB_WORKSPACE}/results/${{ matrix.language }}.sarif"
        echo "Combining SARIF files using the CodeQL CLI"
        codeql database analyze ${GITHUB_WORKSPACE}/${{ matrix.language }}-db my-query.ql --format=sarifv2.1.0 --output ${GITHUB_WORKSPACE}/results/${{ matrix.language }}.sarif
        echo "Adding fingerprints to SARIF file. See https://docs.github.com/en/enterprise-cloud@latest/code-security/code-scanning/integrating-with-code-scanning/sarif-support-for-code-scanning#providing-data-to-track-code-scanning-alerts-across-runs for more information."
      env:
        CODEQL_ACTION_FEATURE_MULTI_LANGUAGE: false
        CODEQL_ACTION_FEATURE_SANDWICH: false
        CODEQL_ACTION_FEATURE_SARIF_COMBINE: true
        CODEQL_ACTION_FEATURE_WILL_UPLOAD: true
        CODEQL_ACTION_VERSION: 2.25.15
        CODEQL_V2_DEPRECATION_WARNING: true
        JOB_RUN_UUID: ${{ github.run_id }}
        CODEQL_ACTION_INIT_HAS_RUN: true
        CODEQL_ACTION_ANALYSIS_KEY: .github/workflows/codeql.yaml:analyze
        CODEQL_WORKFLOW_STARTED_AT: ${{ github.event.workflow_run.created_at }}
        CODEQL_RAM: 14567
        CODEQL_THREADS: 4
        CODEQL_ACTION_AUTOBUILD_DID_COMPLETE_SUCCESSFULLY: true
        CODEQL_UPLOAD_SARIF__LANGUAGE_${{ matrix.language }}__CODEQL: CODEQL_UPLOAD_SARIF__LANGUAGE_${{ matrix.language }}__CODEQL
        CODEQL_ACTION_ANALYZE_DID_COMPLETE_SUCCESSFULLY: true